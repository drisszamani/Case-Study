pipeline {
    agent any

    tools {
        jdk 'JDK 17'
        maven 'Maven_3.9.9'
    }

    environment {
        MAVEN_OPTS = '-Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.count=3'
    }

    stages {
        stage('Build & Test') {
            steps {
                sh '''
                    cd car && mvn clean package
                    cd ../client && mvn clean package
                    cd ../gateway && mvn clean package
                    cd ../server_eureka && mvn clean package
                '''
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                sh '''
                    cd car && docker build -t drisszamanii/car:latest -f ../docker/car/Dockerfile .
                    cd ../client && docker build -t drisszamanii/client:latest -f ../docker/client/Dockerfile .
                    cd ../gateway && docker build -t drisszamanii/gateway:latest -f ../docker/gateway/Dockerfile .
                    cd ../server_eureka && docker build -t drisszamanii/eureka:latest -f ../docker/eureka/Dockerfile .
                '''
            }
        }

        stage('Deploy') {
            steps {
                withKubeConfig([credentialsId: 'kubeconfig']) {
                    sh 'kubectl apply -f k8s/'
                }
            }
        }
    }
}
